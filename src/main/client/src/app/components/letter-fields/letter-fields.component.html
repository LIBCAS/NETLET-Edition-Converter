<div *ngIf="_letter" class="app-letter">

  <div class="app-fxLayout app-row app-center-v app-mb-4">
    <div  *ngFor="let sel of _letter.selection" (click)="gotoPage(sel.page)">
      <span style="position: absolute;">{{ sel.page }}</span>
      <span style="position: relative;float: right;left:-15px;" (click)="removeSelection(sel.page)">X</span>
      <img style="height: 100px; border: 1px solid #aaa; margin-right: 2px;" [src]="getImgUrl(sel)" />
    </div>
    
  </div>

  <button mat-flat-button color="primary" (click)="analyze()" class="app-mb-4">
    <mat-icon class="material-icons-outlined">manage_search</mat-icon>
    {{ 'action.process' | translate}}
  </button>
  
  <div class="app-mb-4">
    <mat-form-field class="app-w-100" appearance="outline">
      <mat-label>{{ 'field.full_text' | translate}}</mat-label>
      <textarea rows="5" matInput [(ngModel)]="_letter.full_text" name="full_text"></textarea>
      <div class="app-pt-4 app-mb-n2 app-text-right">
        <ng-container *ngTemplateOutlet="icons; context:{ field: 'full_text' }"></ng-container>
      </div>
    </mat-form-field>
  </div>

  <div class="app-fxLayout app-row app-center-v app-mb-4">
    <mat-form-field class="app-fxFlex" appearance="outline">
      <mat-label>{{ 'field.startPage' | translate}}</mat-label>
      <input matInput [(ngModel)]="_letter.startPage" name="startPage" />
    </mat-form-field>
    <mat-form-field class="app-fxFlex app-ml-3" appearance="outline">
      <mat-label>{{ 'field.letter_number' | translate}}</mat-label>
      <input matInput [(ngModel)]="_letter.letter_number" name="letter_number">
    </mat-form-field>
    <mat-form-field class="app-fxFlex app-ml-3" appearance="outline">
      <mat-label>{{ 'field.page_number' | translate}}</mat-label>
      <input matInput [(ngModel)]="_letter.page_number" name="page_number">
    </mat-form-field>
    <mat-form-field class="app-fxFlex app-ml-3" appearance="outline">
      <mat-label>{{ 'field.end_page_number' | translate}}</mat-label>
      <input matInput [(ngModel)]="_letter.end_page_number" name="end_page_number">
    </mat-form-field>
  </div>
  
  <div class="app-fxLayout app-row app-center-v app-mb-4">
    <mat-form-field class="app-fxFlex" appearance="outline">
      <mat-label>{{ 'field.author' | translate}}</mat-label>
      <input matInput [(ngModel)]="_letter.author" name="author" /><span matSuffix></span>
      <ng-container matSuffix *ngTemplateOutlet="icons; context:{ field: 'author' }"></ng-container>
    </mat-form-field>
    <mat-form-field class="app-fxFlex app-ml-3" appearance="outline">
      <mat-label>{{ 'field.author_db' | translate}}</mat-label>
      <mat-select [(ngModel)]="_letter.author_db">
          <mat-option *ngFor="let a of _letter.authors_db" [value]="a">{{a.name}} ({{ a.tenant }})</mat-option>
      </mat-select>
    </mat-form-field>

    <mat-icon (click)="switchAuthors()" class="app-ml-2 app-mr-2">sync_alt</mat-icon>
    <mat-form-field class="app-fxFlex" appearance="outline">
      <mat-label>{{ 'field.recipient' | translate}}</mat-label>
      <input matInput [(ngModel)]="_letter.recipient" name="recipient"><span matSuffix></span>
      <ng-container matSuffix *ngTemplateOutlet="icons; context:{ field: 'recipient' }"></ng-container>
    </mat-form-field>
    <mat-form-field class="app-fxFlex app-ml-3" appearance="outline">
      <mat-label>{{ 'field.recipient_db' | translate}}</mat-label>
      <mat-select [(ngModel)]="_letter.recipient_db">
          <mat-option *ngFor="let a of _letter.recipients_db" [value]="a">{{a.name}} ({{ a.tenant }})</mat-option>
      </mat-select>
    </mat-form-field>
    
    <button mat-flat-button (click)="checkAuthors()" [title]="'action.check_authors' | translate">
      <mat-icon color="primary" class="material-icons-outlined app-ml-2 app-mr-2">how_to_reg</mat-icon>
    </button>

  </div>
  <div class="app-mb-4">
    <!-- <mat-form-field class="app-fxFlex" appearance="outline">
      <mat-label>{{ 'field.date_year' | translate}}</mat-label>
      <input matInput [(ngModel)]="_letter.date_year" name="date_year"><span matSuffix></span>
      <ng-container matSuffix *ngTemplateOutlet="icons; context:{ field: 'date_year' }"></ng-container>
    </mat-form-field> -->
    <mat-form-field class="app-fxFlex" appearance="outline" *ngIf="datum">
      <mat-label>{{ 'field.date' | translate}}</mat-label>
      <input matInput [matDatepicker]="picker" [formControl]="datum" >
      <mat-datepicker-toggle matIconSuffix [for]="picker"></mat-datepicker-toggle>
      <mat-datepicker #picker></mat-datepicker>
      <!-- <input matInput [value]="datum | date : 'dd.MM.yyyy' " name="datum" /> -->
    </mat-form-field>

    <mat-form-field class="app-fxFlex app-ml-3" appearance="outline">
      <mat-label>{{ 'field.languages' | translate}}</mat-label>
      <input matInput [(ngModel)]="_letter.languages" name="languages">
  </mat-form-field>

  </div>
  <div class="app-fxLayout app-row app-center-v app-mb-4">
    <mat-form-field class="app-fxFlex" appearance="outline">
      <mat-label>{{ 'field.origin' | translate}}</mat-label>
      <input matInput [(ngModel)]="_letter.origin" name="origin"><span matSuffix></span>
      <ng-container matSuffix *ngTemplateOutlet="icons; context:{ field: 'origin' }"></ng-container>
    </mat-form-field>
    <mat-form-field class="app-fxFlex app-ml-3" appearance="outline">
      <mat-label>{{ 'field.salutation' | translate}}</mat-label>
      <input matInput [(ngModel)]="_letter.salutation" name="salutation"><span matSuffix></span>
      <ng-container matSuffix *ngTemplateOutlet="icons; context:{ field: 'salutation' }"></ng-container>
    </mat-form-field>
    <mat-form-field class="app-fxFlex app-ml-3" appearance="outline">
      <mat-label>{{ 'field.signature' | translate}}</mat-label>
      <input matInput [(ngModel)]="_letter.signature" name="signature"><span matSuffix></span>
      <ng-container matSuffix *ngTemplateOutlet="icons; context:{ field: 'signature' }"></ng-container>
    </mat-form-field>

  </div>
  <div class="app-mb-4">
    <mat-form-field class="app-w-100" appearance="outline">
      <mat-label>{{ 'field.incipit' | translate}}</mat-label>
      <input matInput [(ngModel)]="_letter.incipit" name="incipit"><span matSuffix></span>
      <ng-container matSuffix *ngTemplateOutlet="icons; context:{ field: 'incipit' }"></ng-container>
    </mat-form-field>
  </div>
  <div class="app-mb-4">
    <mat-form-field class="app-w-100" appearance="outline">
      <mat-label>{{ 'field.explicit' | translate}}</mat-label>
      <input matInput [(ngModel)]="_letter.explicit" name="explicit"><span matSuffix></span>
      <ng-container matSuffix *ngTemplateOutlet="icons; context:{ field: 'explicit' }"></ng-container>
    </mat-form-field>
  </div>
    
    <mat-form-field class="app-w-100" appearance="outline">
      <mat-label>{{ 'field.abstract' | translate}}</mat-label>
      <textarea rows="5" matInput [(ngModel)]="_letter.abstract_cs" name="abstract" #abstract></textarea>
    </mat-form-field>
  <mat-tab-group>
    <mat-tab label="HIKO">
      <div class="app-pt-4 app-pb-4 app-pr-4">
        <div *ngFor="let entity of _letter.entities">
          <mat-checkbox [id]="entity.id" [name]="entity.id" type="checkbox" [(ngModel)]="entity.selected" >{{ entity.key_cze }} ({{ entity.tenant }} - {{entity.type}})</mat-checkbox>
        </div>
      </div>
      <!-- <div class="app-fields-row">
        <mat-list role="list">
          <mat-list-item *ngFor="let entity of _letter.entities" role="listitem">
            <input [id]="entity.id" [name]="entity.id" type="checkbox" [(ngModel)]="entity.selected" />
            <label [for]="entity.id">{{ entity.key_cze }} ({{ entity.tenant }} - {{entity.type}})</label>
          </mat-list-item>
        </mat-list>
      </div> -->
    </mat-tab>
    <mat-tab label="NameTag">
      <div class="app-pt-4 app-pb-4 app-pr-4">
        <div *ngFor="let entity of _letter.nametags; let idx = index;">
          <mat-checkbox [id]="'nametag_' + idx" [name]="'nametag_' + idx" type="checkbox" [(ngModel)]="entity.selected">{{entity.text}} ({{ 'tags.' + entity.type | translate}})</mat-checkbox>
        </div>
      </div>
      <!-- <div class="app-fields-row">
        <mat-list role="list" *ngIf="nametags">
          <mat-list-item *ngFor="let entity of nametags; let idx = index;"  role="listitem">
            <input [id]="'nametag_' + idx" [name]="'nametag_' + idx" type="checkbox" [(ngModel)]="entity.selected" />
            <label [for]="'nametag_' + idx">{{entity.text}} ({{ 'tags.' + entity.type | translate}})</label>
          </mat-list-item>
        </mat-list>
      </div> -->
    </mat-tab>
  </mat-tab-group>
</div>

<ng-template #icons let-field="field">
  <mat-icon class="app-suffix app-color-block" (click)="setField(field, 'block', $event)" [matTooltip]="'action.set_block' | translate" >menu_open</mat-icon>
  <mat-icon class="app-suffix app-color-line"  (click)="setField(field, 'line', $event)" [matTooltip]="'action.set_line' | translate">menu_open</mat-icon>
  <mat-icon class="app-suffix app-color-word"  (click)="setField(field, 'word', $event)" [matTooltip]="'action.set_word' | translate">menu_open</mat-icon>
</ng-template>